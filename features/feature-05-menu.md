# Пункт 5: Фича /menu — меню с четырьмя вариантами

План: [feature-plan.md](feature-plan.md)

**Статус:** ⏳ Не реализовано  
**Коммит:** —

## Цель

Реализовать команду `/menu`, которая показывает пользователю меню с **четырьмя** вариантами выбора режима обработки изображений и кнопкой «Назад»:

1. **Очень хорошая детальная реставрация** — режим с максимально качественной реставрацией изображения.
2. **Просто апскейл** — только увеличение разрешения без реставрации.
3. **Только рамка (стиль ветерана)** — добавление рамки в стиле «ветеран» к фото.
4. **Кнопка «Назад»** — закрыть меню без смены режима.

## Поведение

### Команда `/menu`

- Отправить сообщение с **InlineKeyboard**:
  - Три кнопки выбора режима (реставрация, апскейл, рамка ветерана).
  - Четвёртая кнопка — «Назад».
- Рекомендуемая раскладка: три кнопки режимов в один или два ряда, кнопка «Назад» — отдельным рядом.

### Callback_data

| Кнопка                         | callback_data     |
|--------------------------------|-------------------|
| Очень хорошая детальная реставрация | `mode=restoration` |
| Просто апскейл                  | `mode=upscale`    |
| Только рамка (стиль ветерана)  | `mode=frame_veteran` |
| Назад                          | `action=back`     |

### При нажатии на режим (restoration / upscale / frame_veteran)

1. Вызвать `answerCallbackQuery` (чтобы Telegram убрал «часики» у кнопки).
2. Сохранить выбранный режим в S3: `users/{chat_id}.json` (поле `mode`).
3. Отправить подтверждение: «Выбран режим: …» (краткое название режима).

### При нажатии «Назад»

1. Вызвать `answerCallbackQuery`.
2. Закрыть меню: отредактировать сообщение с меню, убрав клавиатуру (`editMessageReplyMarkup` с пустой разметкой), либо удалить сообщение, либо отправить короткий текст «Меню закрыто». Режим пользователя не менять.

## Маппинг режимов на Replicate

При отправке фото текущий режим берётся из `users/{chat_id}.json`. В задачу `tasks/{prediction_id}.json` и в запрос к Replicate передаётся поле `mode`:

- **restoration** — модель/параметры для детальной реставрации (например, codeformer или аналог с высоким качеством).
- **upscale** — модель/параметры только для апскейла (без реставрации).
- **frame_veteran** — модель/параметры для добавления рамки в стиле ветерана.

Конкретные `REPLICATE_MODEL_VERSION` и параметры `input` для каждого режима могут различаться; при необходимости задать переменные окружения или маппинг в конфиге/логике (см. [src/domain/logic.py](../src/domain/logic.py), [src/services/replicate_api.py](../src/services/replicate_api.py)).

Если режим не задан или файл `users/{chat_id}.json` отсутствует — использовать режим по умолчанию (например, `restoration`).

## Файлы для изменения

| Файл | Изменения |
|------|-----------|
| [spec/06-handlers.md](../spec/06-handlers.md) | Описание /menu и CallbackQuery с четырьмя вариантами и callback_data. |
| [src/domain/models.py](../src/domain/models.py) | Расширить enum `BotMode`: добавить `RESTORATION`, `UPSCALE`, `FRAME_VETERAN`; при необходимости сохранить обратную совместимость с `PROCESS_PHOTO`/`FRAME`. |
| [src/handlers/telegram_processor.py](../src/handlers/telegram_processor.py) | Реализовать отправку сообщения с InlineKeyboard при `/menu`; реализовать обработку `callback_query` (выбор режима и «Назад»). |
| [src/services/telegram_api.py](../src/services/telegram_api.py) | При необходимости: метод отправки сообщения с `reply_markup` (InlineKeyboardMarkup), вызов `answer_callback_query`, при «Назад» — `editMessageReplyMarkup` или удаление сообщения. |
| [src/domain/logic.py](../src/domain/logic.py) | При необходимости: передача режима в Replicate (выбор модели/версии и параметров по `mode`). |
| [src/services/replicate_api.py](../src/services/replicate_api.py) | При необходимости: поддержка разных моделей/параметров в зависимости от режима. |

## Связанные документы

- [spec/06-handlers.md](../spec/06-handlers.md) — логика fn-handler и CallbackQuery.
- [feature-plan.md](feature-plan.md) — план фич.
